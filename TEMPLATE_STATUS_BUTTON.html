<!-- 
  ğŸ“Š TEMPLATE STATUS BUTTON & MODAL
  Bu kodu bulk_send.html'e ekleyin
-->

<!-- 1ï¸âƒ£ BUTON - GÃ¶nderim loglarÄ± butonunun yanÄ±na ekleyin -->
<button onclick="showTemplateStatusModal()" class="btn btn-info">
  <i class="fas fa-chart-bar"></i> TÃ¼m ContactlarÄ±n Durumu
</button>

<!-- 2ï¸âƒ£ MODAL - SayfanÄ±n en altÄ±na ekleyin -->
<div class="modal fade" id="templateStatusModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          ğŸ“Š <span id="templateNameTitle"></span> - TÃ¼m ContactlarÄ±n Durumu
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Ä°statistikler -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body text-center">
                <h6 class="text-muted">Toplam Contact</h6>
                <h2 class="text-primary" id="statTotal">0</h2>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-body text-center">
                <h6 class="text-muted">âœ… GÃ¶nderildi</h6>
                <h2 class="text-success" id="statSent">0</h2>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-danger">
              <div class="card-body text-center">
                <h6 class="text-muted">âŒ GÃ¶nderilmedi</h6>
                <h2 class="text-danger" id="statNotSent">0</h2>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Filtreleme ve Arama -->
        <div class="row mb-3">
          <div class="col-md-8">
            <input type="text" id="searchContact" class="form-control" 
                   placeholder="ğŸ” Ä°sim veya telefon ara..." 
                   onkeyup="filterStatusContacts()">
          </div>
          <div class="col-md-4">
            <button onclick="exportStatusToCSV()" class="btn btn-success w-100">
              <i class="fas fa-file-excel"></i> Excel Ä°ndir
            </button>
          </div>
        </div>
        
        <div class="btn-group mb-3" role="group">
          <button onclick="filterStatusBySent(null)" class="btn btn-outline-secondary active" id="filterAll">
            TÃ¼mÃ¼
          </button>
          <button onclick="filterStatusBySent(true)" class="btn btn-outline-success" id="filterSent">
            âœ… Sadece GÃ¶nderildi
          </button>
          <button onclick="filterStatusBySent(false)" class="btn btn-outline-danger" id="filterNotSent">
            âŒ Sadece GÃ¶nderilmedi
          </button>
        </div>
        
        <!-- Loading -->
        <div id="statusLoading" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">YÃ¼kleniyor...</span>
          </div>
          <p class="mt-2">Contact'lar yÃ¼kleniyor...</p>
        </div>
        
        <!-- Tablo -->
        <div id="statusTableContainer" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-striped table-hover">
            <thead class="table-dark sticky-top">
              <tr>
                <th>Ä°sim</th>
                <th>Telefon</th>
                <th>Ãœlke</th>
                <th>Durum</th>
                <th>Status</th>
                <th>GÃ¶nderim Tarihi</th>
              </tr>
            </thead>
            <tbody id="statusTableBody">
              <!-- JavaScript ile doldurulacak -->
            </tbody>
          </table>
        </div>
        
        <div id="statusEmpty" class="text-center py-5 text-muted" style="display: none;">
          <i class="fas fa-inbox fa-3x mb-3"></i>
          <p>SonuÃ§ bulunamadÄ±</p>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          GÃ¶sterilen: <span id="showingCount">0</span> contact
        </small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<!-- 3ï¸âƒ£ JAVASCRIPT - <script> tagÄ± iÃ§ine ekleyin -->
<script>
let allStatusContacts = [];
let currentStatusFilter = null; // null, true, false
let currentTemplateName = '';

async function showTemplateStatusModal() {
  // Template adÄ±nÄ± al
  const templateSelect = document.getElementById('template');
  if (!templateSelect || !templateSelect.value) {
    alert('LÃ¼tfen bir template seÃ§in');
    return;
  }
  
  currentTemplateName = templateSelect.value;
  
  // Modal'Ä± aÃ§
  const modal = new bootstrap.Modal(document.getElementById('templateStatusModal'));
  modal.show();
  
  // Verileri yÃ¼kle
  await loadTemplateStatus();
}

async function loadTemplateStatus() {
  document.getElementById('statusLoading').style.display = 'block';
  document.getElementById('statusTableContainer').style.display = 'none';
  document.getElementById('statusEmpty').style.display = 'none';
  
  try {
    const response = await fetch(`/api/bulk-send/template-status?template_name=${currentTemplateName}`);
    const data = await response.json();
    
    if (data.success) {
      allStatusContacts = data.contacts;
      
      // BaÅŸlÄ±k ve istatistikleri gÃ¼ncelle
      document.getElementById('templateNameTitle').textContent = data.template_name;
      document.getElementById('statTotal').textContent = data.stats.total_contacts;
      document.getElementById('statSent').textContent = data.stats.sent;
      document.getElementById('statNotSent').textContent = data.stats.not_sent;
      
      // Tabloyu render et
      renderStatusTable();
      
      document.getElementById('statusLoading').style.display = 'none';
      document.getElementById('statusTableContainer').style.display = 'block';
    } else {
      alert('Hata: ' + data.error);
      document.getElementById('statusLoading').style.display = 'none';
    }
  } catch (error) {
    console.error('Template status error:', error);
    alert('Bir hata oluÅŸtu: ' + error.message);
    document.getElementById('statusLoading').style.display = 'none';
  }
}

function filterStatusBySent(sentStatus) {
  currentStatusFilter = sentStatus;
  
  // Buton active state'leri
  document.querySelectorAll('#templateStatusModal .btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (sentStatus === null) {
    document.getElementById('filterAll').classList.add('active');
  } else if (sentStatus === true) {
    document.getElementById('filterSent').classList.add('active');
  } else {
    document.getElementById('filterNotSent').classList.add('active');
  }
  
  renderStatusTable();
}

function filterStatusContacts() {
  renderStatusTable();
}

function renderStatusTable() {
  const searchTerm = document.getElementById('searchContact').value.toLowerCase();
  
  // Filtreleme
  let filtered = allStatusContacts;
  
  // Sent/Not sent filtresi
  if (currentStatusFilter !== null) {
    filtered = filtered.filter(c => c.sent === currentStatusFilter);
  }
  
  // Arama filtresi
  if (searchTerm) {
    filtered = filtered.filter(c => 
      c.name.toLowerCase().includes(searchTerm) ||
      c.phone.includes(searchTerm)
    );
  }
  
  // Tablo render
  const tbody = document.getElementById('statusTableBody');
  tbody.innerHTML = '';
  
  if (filtered.length === 0) {
    document.getElementById('statusTableContainer').style.display = 'none';
    document.getElementById('statusEmpty').style.display = 'block';
    return;
  }
  
  document.getElementById('statusTableContainer').style.display = 'block';
  document.getElementById('statusEmpty').style.display = 'none';
  
  filtered.forEach(contact => {
    const row = document.createElement('tr');
    row.className = contact.sent ? 'table-success' : 'table-light';
    
    // Tarih formatla
    let sentDate = '-';
    if (contact.sent_at) {
      const date = new Date(contact.sent_at);
      sentDate = date.toLocaleString('tr-TR');
    }
    
    // Status badge
    let statusBadge = '';
    if (contact.sent) {
      if (contact.status === 'delivered') {
        statusBadge = '<span class="badge bg-success">âœ… Teslim Edildi</span>';
      } else if (contact.status === 'read') {
        statusBadge = '<span class="badge bg-primary">ğŸ‘ï¸ Okundu</span>';
      } else if (contact.status === 'sent') {
        statusBadge = '<span class="badge bg-info">ğŸ“¤ GÃ¶nderildi</span>';
      }
    } else {
      statusBadge = '<span class="badge bg-danger">âŒ GÃ¶nderilmedi</span>';
    }
    
    row.innerHTML = `
      <td><strong>${contact.name}</strong></td>
      <td>${contact.phone}</td>
      <td>${contact.country || '-'}</td>
      <td>
        ${contact.sent 
          ? '<span class="text-success">âœ… GÃ¶nderildi</span>' 
          : '<span class="text-danger">âŒ GÃ¶nderilmedi</span>'}
      </td>
      <td>${statusBadge}</td>
      <td><small>${sentDate}</small></td>
    `;
    
    tbody.appendChild(row);
  });
  
  document.getElementById('showingCount').textContent = filtered.length;
}

function exportStatusToCSV() {
  const csv = ['Ä°sim,Telefon,Ãœlke,Durum,Status,GÃ¶nderim Tarihi'];
  
  allStatusContacts.forEach(c => {
    const sent = c.sent ? 'GÃ¶nderildi' : 'GÃ¶nderilmedi';
    const date = c.sent_at ? new Date(c.sent_at).toLocaleString('tr-TR') : '';
    
    csv.push([
      c.name,
      c.phone,
      c.country || '',
      sent,
      c.status,
      date
    ].join(','));
  });
  
  const blob = new Blob(['\uFEFF' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentTemplateName}-durum-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  
  alert('Excel dosyasÄ± indirildi!');
}
</script>

<!-- 4ï¸âƒ£ CSS (opsiyonel - daha gÃ¼zel gÃ¶rÃ¼nÃ¼m iÃ§in) -->
<style>
#templateStatusModal .table-responsive {
  border: 1px solid #dee2e6;
  border-radius: 8px;
}

#templateStatusModal .sticky-top {
  position: sticky;
  top: 0;
  z-index: 10;
}

#templateStatusModal .card {
  transition: transform 0.2s;
}

#templateStatusModal .card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
